# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

name: Publish release

on:
  push:
    tags: [ "v*.*.*" ]

env:
  registry: "ghcr.io"
jobs:
  get_semver:
    name: Get Semantic Version
    runs-on: ubuntu-latest
    outputs:
      semver: ${{ steps.get.outputs.semver }}
    steps:
    - id: get
      env:
        RELEASE_VERSION: ${{ github.ref_name }}
      run: |
        if [[ "${RELEASE_VERSION}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
          echo "semver=${RELEASE_VERSION/v/}" >> "$GITHUB_OUTPUT"
        else
          # If ref name does not match semver, default to 0.0.0.
          # This happens when running from a branch such as main.
          echo "semver=0.0.0" >> "$GITHUB_OUTPUT"
        fi

  # Note: When modifying this job, copy modifications to all other workflow image jobs.
  all_component_images:
    needs: get_semver
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
        - name: coturn
          context: addons/coturn
          platforms: linux/amd64,linux/arm64

        - name: coturn-web
          context: addons/coturn-web
          platforms: linux/amd64,linux/arm64

        - name: gst-web
          context: addons/gst-web

        - name: gstreamer
          version_suffix: -ubuntu20.04
          build_args: |
            DISTRIB_RELEASE=20.04
          context: addons/gstreamer
          platforms: linux/amd64,linux/arm64

        - name: gstreamer
          version_suffix: -ubuntu22.04
          build_args: |
            DISTRIB_RELEASE=22.04
          context: addons/gstreamer
          platforms: linux/amd64,linux/arm64

        - name: js-interposer
          version_suffix: -ubuntu20.04
          build_args: |
            DISTRIB_RELEASE=20.04
            PKG_NAME=selkies-js-interposer
            PKG_VERSION=${{ needs.get_semver.outputs.semver }}
          context: addons/js-interposer
          dockerfile: Dockerfile.ubuntu_debpkg
          platforms: linux/amd64,linux/arm64

        - name: js-interposer
          version_suffix: -ubuntu22.04
          build_args: |
            DISTRIB_RELEASE=22.04
            PKG_NAME=selkies-js-interposer
            PKG_VERSION=${{ needs.get_semver.outputs.semver }}
          context: addons/js-interposer
          dockerfile: Dockerfile.ubuntu_debpkg
          platforms: linux/amd64,linux/arm64

        - name: infra-gcp-installer
          context: infra/gce/installer-image
          diff: infra/gce

        - name: py-build
          build_args: |
            PACKAGE_VERSION=${{ needs.get_semver.outputs.semver }}
          context: .

    name: ${{ matrix.name }}${{ matrix.version_suffix }} image build & publish
    steps:
    - uses: actions/checkout@v4

    - name: Build & publish ${{ matrix.name }} image
      uses: ./.github/actions/build_and_publish_image
      with:
        build_args: ${{ matrix.build_args }}
        context: ${{ matrix.context }}
        dockerfile: ${{ matrix.dockerfile }}
        platforms: ${{ matrix.platforms }}
        push: true
        subproject: ${{ matrix.name }}
        tags: |
          ${{ env.registry }}/${{ github.repository }}/${{ matrix.name }}:${{ github.ref_name }}${{ matrix.version_suffix }}
          ${{ env.registry }}/${{ github.repository }}/${{ matrix.name }}:latest${{ matrix.version_suffix }}

  # Note: When modifying this job, copy modifications to all other workflow image jobs.
  all_example_images:
    needs:
    - get_semver
    - all_component_images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
        - name: gst-py-example
          version_suffix: -ubuntu20.04
          build_args: |
            PACKAGE_VERSION=${{ needs.get_semver.outputs.semver }}
            DISTRIB_RELEASE=20.04
            GSTREAMER_BASE_IMAGE_RELEASE=${{ github.ref_name }}
            PY_BUILD_IMAGE=${{ env.registry }}/${{ github.repository }}/py-build:${{ github.ref_name }}
            WEB_IMAGE=${{ env.registry }}/${{ github.repository }}/gst-web:${{ github.ref_name }}
            JS_BASE_IMAGE_RELEASE=${{ github.ref_name }}
            JS_BASE_IMAGE=${{ env.registry }}/${{ github.repository }}/js-interposer
          dockerfile: Dockerfile.example
          context: .

        - name: gst-py-example
          version_suffix: -ubuntu22.04
          build_args: |
            PACKAGE_VERSION=${{ needs.get_semver.outputs.semver }}
            DISTRIB_RELEASE=22.04
            GSTREAMER_BASE_IMAGE_RELEASE=${{ github.ref_name }}
            PY_BUILD_IMAGE=${{ env.registry }}/${{ github.repository }}/py-build:${{ github.ref_name }}
            WEB_IMAGE=${{ env.registry }}/${{ github.repository }}/gst-web:${{ github.ref_name }}
            JS_BASE_IMAGE_RELEASE=${{ github.ref_name }}
            JS_BASE_IMAGE=${{ env.registry }}/${{ github.repository }}/js-interposer
          dockerfile: Dockerfile.example
          context: .

    name: ${{ matrix.name }}${{ matrix.version_suffix }} image build & publish
    steps:
    - uses: actions/checkout@v4

    - name: Build & publish ${{ matrix.name }} image
      uses: ./.github/actions/build_and_publish_image
      with:
        build_args: ${{ matrix.build_args }}
        context: ${{ matrix.context }}
        dockerfile: ${{ matrix.dockerfile }}
        platforms: ${{ matrix.platforms }}
        push: true
        subproject: ${{ matrix.name }}
        tags: |
          ${{ env.registry }}/${{ github.repository }}/${{ matrix.name }}:${{ github.ref_name }}${{ matrix.version_suffix }}
          ${{ env.registry }}/${{ github.repository }}/${{ matrix.name }}:latest${{ matrix.version_suffix }}

  create_release:
    needs:
    - get_semver
    - all_component_images
    - all_example_images
    runs-on: ubuntu-latest
    name: Create ${{ github.ref }} draft release
    steps:
    - uses: softprops/action-gh-release@v2
      with:
        name: "Release ${{ github.ref }}"
        tag_name: ${{ github.ref }}
        body: "**By downloading the GStreamer build files, you acknowledge and agree to the terms of libraries and executables licensed GPLv2, GPLv3 or https://developer.download.nvidia.com/compute/cuda/redist/cuda_nvrtc/LICENSE.txt.**"
        draft: true
        generate_release_notes: true

  all_assets:
    needs:
    - get_semver
    - all_component_images
    - all_example_images
    - create_release
    runs-on: ubuntu-latest
    env:
      TEMP_DIR: /tmp
    strategy:
      matrix:
        include:
        - name: gstreamer
          version_suffix: -ubuntu20.04
          source: /opt/selkies-gstreamer-latest.tar.xz
          target_name: gstreamer-selkies_gpl_${{ github.ref_name }}_ubuntu20.04_amd64.tar.xz

        - name: gstreamer
          version_suffix: -ubuntu22.04
          source: /opt/selkies-gstreamer-latest.tar.xz
          target_name: gstreamer-selkies_gpl_${{ github.ref_name }}_ubuntu22.04_amd64.tar.xz

        - name: gstreamer
          version_suffix: -ubuntu20.04
          platforms: linux/arm64
          source: /opt/selkies-gstreamer-latest.tar.xz
          target_name: gstreamer-selkies_gpl_${{ github.ref_name }}_ubuntu20.04_arm64.tar.xz

        - name: gstreamer
          version_suffix: -ubuntu22.04
          platforms: linux/arm64
          source: /opt/selkies-gstreamer-latest.tar.xz
          target_name: gstreamer-selkies_gpl_${{ github.ref_name }}_ubuntu22.04_arm64.tar.xz

        - name: js-interposer
          version_suffix: -ubuntu20.04
          source: /opt/selkies-js-interposer_${{ needs.get_semver.outputs.semver }}.deb
          target_name: selkies-js-interposer_${{ github.ref_name }}_ubuntu20.04_amd64.deb

        - name: js-interposer
          version_suffix: -ubuntu22.04
          source: /opt/selkies-js-interposer_${{ needs.get_semver.outputs.semver }}.deb
          target_name: selkies-js-interposer_${{ github.ref_name }}_ubuntu22.04_amd64.deb

        - name: js-interposer
          version_suffix: -ubuntu20.04
          platforms: linux/arm64
          source: /opt/selkies-js-interposer_${{ needs.get_semver.outputs.semver }}.deb
          target_name: selkies-js-interposer_${{ github.ref_name }}_ubuntu20.04_arm64.deb

        - name: js-interposer
          version_suffix: -ubuntu22.04
          platforms: linux/arm64
          source: /opt/selkies-js-interposer_${{ needs.get_semver.outputs.semver }}.deb
          target_name: selkies-js-interposer_${{ github.ref_name }}_ubuntu22.04_arm64.deb

        - name: py-build
          source: /opt/pypi/dist/selkies_gstreamer-${{ needs.get_semver.outputs.semver }}-py3-none-any.whl
          target_name: selkies_gstreamer-${{ needs.get_semver.outputs.semver }}-py3-none-any.whl

        - name: gst-web
          source: /opt/gst-web.tar.xz
          target_name: selkies-gstreamer-web_${{ github.ref_name }}.tar.xz

    name: ${{ matrix.description }} release artifact extraction & upload
    steps:
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log into registry ${{ env.registry }}
      uses: docker/login-action@v3
      with:
        registry: ${{ env.registry }}
        username: ${{ github.actor }}
        password: ${{ github.token }}

    - name: ${{ matrix.description }} release artifact extraction
      run: |
        docker container create --name=copy --platform="${{ matrix.platforms || 'linux/amd64' }}" "${{ env.registry }}/${{ github.repository }}/${{ matrix.name }}:${{ github.ref_name }}${{ matrix.version_suffix }}"
        TARGET_PATH="${{ env.TEMP_DIR }}/${{ matrix.target_name }}"
        docker container cp "copy:${{ matrix.source }}" "${TARGET_PATH}"
        if [ -d "${TARGET_PATH}" ]; then
          SOURCE_DIRNAME=$(echo "${{ matrix.source }}" | sed 's:.*/::')
          cd "${{ env.TEMP_DIR }}" && mv -f "${TARGET_PATH}" "${SOURCE_DIRNAME}"
          XZ_OPT='-T0' tar -cJvf "temp.tar.xz" "${SOURCE_DIRNAME}" && rm -rf "${SOURCE_DIRNAME}" && mv -f "temp.tar.xz" "${TARGET_PATH}"
        fi
        docker container rm --force --volumes copy

    - name: ${{ matrix.description }} upload
      uses: svenstaro/upload-release-action@v2
      with:
        draft: true
        overwrite: true
        tag: ${{ github.ref }}
        file: ${{ env.TEMP_DIR }}/${{ matrix.target_name }}
