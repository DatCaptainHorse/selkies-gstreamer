#!/usr/bin/env bash
set -e

# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

# Set log directory
export LOGDIR="${LOGDIR:-/tmp}"
# Set default display
export DISPLAY="${DISPLAY:-:0}"

# Activate Conda environment in bin directory
. "$(dirname -- "$( readlink -f -- "$0"; )";)/activate"

export GSTREAMER_PATH="${CONDA_PREFIX}"
export PATH="${GSTREAMER_PATH}/bin${PATH:+:${PATH}}"
export LD_LIBRARY_PATH="${GSTREAMER_PATH}/lib:/usr/lib/x86_64-linux-gnu:/usr/lib:/usr/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}"
export GI_TYPELIB_PATH="${GSTREAMER_PATH}/lib/girepository-1.0:/usr/lib/x86_64-linux-gnu/girepository-1.0:/usr/lib/girepository-1.0:/usr/lib64/girepository-1.0${GI_TYPELIB_PATH:+:${GI_TYPELIB_PATH}}"

# Start Xvfb server in DISPLAY if requested, required in host (package xvfb in Debian or xorg-x11-server-Xvfb in RHEL)
if [ ! -S "/tmp/.X11-unix/X${DISPLAY/:/}" ] && [ -x "$(command -v Xvfb)" ] || [ "${ENABLE_XVFB,,}" = "true" ]; then
    export ENABLE_XVFB="true"
    Xvfb -screen "${DISPLAY}" 8192x4096x24 +extension "COMPOSITE" +extension "DAMAGE" +extension "GLX" +extension "RANDR" +extension "RENDER" +extension "MIT-SHM" +extension "XFIXES" +extension "XTEST" +iglx +render -nolisten "tcp" -noreset -shmem >${LOGDIR}/Xvfb_selkies.log 2>&1 &
fi

# Wait for X server to start
until [ -S "/tmp/.X11-unix/X${DISPLAY/:/}" ]; do sleep 0.5; done
echo 'X Server is ready'

# Use selkies-gstreamer-resize to resize the screen, xrandr required in host (package x11-xserver-utils in Debian or xorg-x11-server-utils/xrandr in RHEL)
if [ "${ENABLE_XVFB,,}" = "true" ]; then ${CONDA_PREFIX}/bin/python ${CONDA_PREFIX}/bin/selkies-gstreamer-resize 1920x1080; fi

# Start PulseAudio server in PULSE_SERVER if requested (bundled with Conda, running applications may need to restart or run afterwards to relay audio)
export PIPEWIRE_LATENCY="32/48000"
export PULSE_SERVER_PATH="${PULSE_SERVER#*:}"
if [ "${ENABLE_PULSEAUDIO,,}" = "true" ] || [ ! -S "${PULSE_SERVER_PATH}" ]; then
    export ENABLE_PULSEAUDIO="true"
    # PipeWire/PulseAudio server socket path
    export PULSE_SERVER="${PULSE_SERVER:-unix:${XDG_RUNTIME_DIR:-/tmp}/pulse/native}"
    export PULSE_CONFIG="${CONDA_PREFIX}/etc/pulse/daemon.conf"
    export PULSE_DLPATH="${CONDA_PREFIX}/lib/pulseaudio/modules"
    ${CONDA_PREFIX}/bin/pulseaudio --verbose --log-target=file:${LOGDIR}/pulseaudio_selkies.log --disallow-exit -F "${CONDA_PREFIX}/etc/pulse/default.pa" &
fi

# Clear the cache registry
rm -rf "${HOME}/.cache/gstreamer-1.0"

# Set Selkies environment variables
export SELKIES_WEB_ROOT="${SELKIES_WEB_ROOT:-${CONDA_PREFIX}/share/selkies-web}"

${CONDA_PREFIX}/bin/python ${CONDA_PREFIX}/bin/selkies-gstreamer $@
